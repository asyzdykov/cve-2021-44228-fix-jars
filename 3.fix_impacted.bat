@echo off
set ZIP_PATH=C:\PROGRA~1\7-Zip\7z.exe
set RESULT_FILE_NAME=log4j_impacted_jars_details.txt
set CURR_DIR=%cd%
set RESULT_FILE=%CURR_DIR%\%RESULT_FILE_NAME%
set APPLY_FIX=TRUE
set timestamp=%DATE:/=-%_%TIME::=-%
set timestamp=%timestamp: =%

IF "%APPLY_FIX%."=="TRUE." (
    @echo.
    @echo ------------------------------------------------------------------------------------
    @echo Applying the fix : Remove JndiLookup.class
    @echo ------------------------------------------------------------------------------------
    IF EXIST "%RESULT_FILE%" (
        FOR /F "tokens=* delims=" %%a in ('Type "%RESULT_FILE%"') DO (
            @echo Fixing file : %%a
			
            FOR /f "tokens=1,2 delims= " %%x in ('attrib %%a') DO (
                IF "%%y."=="R." (
                    attrib -R %%a
                    %ZIP_PATH% d %%a JndiLookup.class -r
                    IF %ERRORLEVEL% NEQ 0 echo %errorlevel% : %%a >> %RESULT_FILE%.error
                    attrib +R %%a
                ) ELSE (
                    %ZIP_PATH% d %%a JndiLookup.class -r
                    IF %ERRORLEVEL% NEQ 0 echo %errorlevel% : %%a >> %RESULT_FILE%.error
                )                
            )
        )
    ) ELSE (
        @echo *** No Jars found to apply fix ***
        @echo *** No Jars found to apply fix *** >> %RESULT_FILE%
    )
) ELSE (
    IF NOT EXIST "%RESULT_FILE%" (
        @echo *** No Impacted Jars found ***
        @echo *** No Impacted Jars found *** >> %RESULT_FILE%
    )
)

pause
